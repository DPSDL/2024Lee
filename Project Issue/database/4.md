## 联合索引在什么场景下会失效？大概有哪几种情况会失效会违背最左原则？

在 MySQL 中，**联合索引**（Composite Index 或 Multiple-Column Index）是指在多个列上创建的索引，可以加速基于这些列的查询。然而，联合索引在某些情况下可能会失效，特别是在违背“最左前缀”原则时。下面是一些常见的场景和情况：

### 1. 不遵循最左前缀原则

MySQL 联合索引的一个重要特性是“最左前缀”原则。联合索引的查询条件必须从索引的最左边开始使用。例如，假设你创建了一个联合索引 `(A, B, C)`，则以下情况不会使用此索引：

- **仅使用中间列**：
    - 查询条件只涉及 `B` 或 `C`：
      ```sql
      SELECT * FROM table WHERE B = 1;  -- 失效
      SELECT * FROM table WHERE C = 1;  -- 失效
      ```

- **按非最左列的顺序查询**：
    - 查询条件涉及 `B` 和 `C`，但不涉及 `A`:
      ```sql
      SELECT * FROM table WHERE B = 1 AND C = 2;  -- 失效
      ```

### 2. 不使用准确的比较运算符

- **使用范围查询**：
    - 当你在查询中对联合索引的某个列使用了范围查询（如 `>`, `<`, `BETWEEN`, `IN`），则其后面所有的列将不再使用索引。
    - 例如：
      ```sql
      SELECT * FROM table WHERE A = 1 AND B > 2;  -- 只会使用索引的 A 列
      ```

### 3. 列类型不匹配

- **数据类型不匹配**：
    - 在 WHERE 子句中对列进行比较时，如果使用了不匹配的类型，比如在整数列上使用字符串，可能会导致书写不当，使索引失效。

### 4. NULL 值的影响

- **NULL 值**：
    - 对于含有 NULL 值的列，如果查询条件是 `IS NULL` 或 `IS NOT NULL`，可能会导致索引失效。通常情况下，如果联合索引的列中有 NULL 值，MySQL 在处理这类查询时可能不使用索引。

### 5. 使用函数或表达式

- **在索引列上使用函数或表达式**：
    - 如果在查询条件中对联合索引中的列使用了函数或表达式，例如：
      ```sql
      SELECT * FROM table WHERE LOWER(A) = 'example';  -- 索引失效
      ```

### 6. 强制查询优化器选择全表扫描

- **使用 `FORCE INDEX` 或特定的查询优化提示**：
    - 如果使用了 `FORCE INDEX` 或其他查询提示，可能会导致查询优化器选择不使用联合索引。

### 7. 统计信息不准确

- **数据分布和统计信息**：
    - 如果数据分布发生变化，而统计信息未更新，可能导致查询优化器错误估计，因而选择全表扫描而非使用索引。

### 总结

联合索引对于优化复杂查询非常有用，但其有效性受多种因素的影响。了解这些失效场景可以帮助你更好地设计数据库索引，确保查询效率最大化。

如果你有具体的用案例或问题，欢迎继续交流！